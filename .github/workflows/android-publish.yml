name: Android Publish

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  check_quality:
    uses: ./.github/workflows/code-quality.yml
    secrets:
      GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}

  build_release:
    name: Build Release App Bundle
    needs: check_quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: gradle

      - name: Create google-services.json
        run: echo "${{ secrets.GOOGLE_SERVICES_JSON }}" | base64 -d > ./android/app/google-services.json

      - name: Decode Keystore
        run: echo "${{ secrets.SIGNING_KEYSTORE_BASE64 }}" | base64 -d > app/keystore.jks

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create local.properties
        run: |
          echo "MAPS_API_KEY=${{ secrets.MAPS_API_KEY }}" > local.properties
          echo "PLACES_API_KEY=${{ secrets.PLACES_API_KEY }}" >> local.properties

      - name: Build Release Bundle
        run: ./gradlew bundleRelease -PBUILD_NUMBER=${{ github.run_number }}
        env:
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.SIGNING_KEY_PASSWORD }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BIF-Locator-Release
          path: app/build/outputs/bundle/release/app-release.aab

  publish_play_store:
    name: Publish to Play Store
    needs: build_release
    environment: production
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android
    steps:
      - uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: BIF-Locator-Release

      - name: Create Service Account File
        run: echo '${{ secrets.PLAY_SERVICE_ACCOUNT_JSON }}' > play_service_account.json

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: play_service_account.json
          packageName: com.bif.locator
          releaseFiles: app-release.aab
          track: internal
          status: draft
